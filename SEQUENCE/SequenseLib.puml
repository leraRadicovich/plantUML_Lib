@startuml

'\TODO Подумать над определением цвета для разных уровней
'\TODO Добавить процедуру opt
'\TODO Добавить процедуру group
'\TODO Добавить процедуру par
'\TODO Написать вспомогательные процедуры, которые будут рисовать код, спрятанный в процедурах библиотеки
'\TODO Написать мануал, как пользоваться библиотекой
'\TODO Подготовить митап
'\TODO Написать библиотеки для UseCase и Activity диаграмм
'\TODO Перенести библиотеку в GIT

'СЛУЖЕБНЫЕ ПРОЦЕДУРЫ'
'Процедура DIAGRAMM_INIT($title) инициирует создание заголовка, списка участников'
!unquoted procedure DIAGRAMM_INIT($title)
    Title $title
    addBox("\nАУТЕНТИФИКАЦИЯ ПАРТНЕРОВ", lightblue, participants)
    addBox("\nWEB", lightgreen, web)
!endprocedure

'Процедура LEGEND() инициирует отображение на диаграмме легенды с картой процесса, представленном на диаграмме, в табличном виде'
!unquoted procedure LEGEND()
    legend left
    Карта процесса
    ====
    $tableProcessDescription
    end legend
!endprocedure

/'Процедура NOTE($mode=0)  инициирует отображение на диаграмме заметки с картой процесса, представленном на диаграмме, в табличном виде (mode=0, дефолтное значение)
и в виде текста с разделителем (mode=1)'/
!unquoted procedure NOTE($mode=0)

!if $mode == 0
note across
Таблица: карта процесса
====
$tableProcessDescription
end note

!elseif $mode == 1
note across
=Текстовое описание процесса (текст с разделителем)
====
$csvProcessDescription
end note
!endif
!endprocedure

'/ПРОЦЕДУРЫ РАБОТЫ С УЧАСТНИКАМИ ПРОЦЕССА И СПИСОК УЧАСТНИКОВ

'/Добавление участника
!unquoted procedure addComponent($type="participant", $participantName, $as, $order=0)
        $type "$participantName" as $as order $order
!end procedure

'/Добавление группы участников
!procedure addBox($box, $colour, $dataSet="", $type="participant", $component="", $as="", $order=0)
    !if $dataSet == participants
        box "$box" #$colour
            !foreach $item in $data.participants
            addComponent($item.type, $item.name, $item.as, $item.order)
            !endfor
        end box
    !elseif $dataSet == web
        box "$box" #$colour
            !foreach $item in $data.web
            addComponent($item.type, $item.name, $item.as, $item.order)
            !endfor
        end box
    !elseif $dataSet == ""
        box "$box" #$colour
            addComponent($item.type, $component, $as, $item.order)
        end box
    !endif
!end procedure

'/JSON с дефолтными группами и участниками
!$data={
  "participants": [
    {"type":"participant", "name": "front (id.vtb.ru)", "as": "front", "order":"10"},
    {"type":"participant", "name": "pafp-partner-is", "as": "pafp", "order":"20"},
    {"type":"database", "name": "redis", "as": "redis", "order":"30"},
    {"type":"database", "name": "PostgreSql", "as": "psql", "order":"40"}
    ],
  "web": [
    {"type":"actor", "name": "Пользователь", "as": "user", "order":"0"},
    {"type":"participant", "name": "Сайт партнера", "as": "site", "order":"1"},
    {"type":"participant", "name": "БЭК-сервис партнера", "as": "part", "order":"2"},
    {"type":"participant", "name": "Анкеты", "as": "anketa", "order":"3"},
    {"type":"participant", "name": "MOS.RU", "as": "mos", "order":"4"}
    ]
}

'/ 4. ПЕРЕМЕННЫЕ, ИСПОЛЬЗУЕМЫЕ ВО ВСЕХ ФУНКЦИЯХ И ПРОЦЕДУРАХ - ГЛБАЛЬНЫЕ ПЕРЕМЕННЫЕ

    '/Счетчик отображаемой (программной) автонумерации стрелок
    !global $counter = 0

    '/Счетчик сквозной автонумерации всех вызовов, технический
    !global $techCounter = 0

    '/Счетчик донорских стрелок в КЭШе
    !global $donorCounter = 0

    /'Дефолтны цвет для альта
    '/
    !global $altColor = "#chocolate"
    !global $altColorStep = 15

    '/Счетчик вложенности альтов
    !global $altLevel = 0

    '/Программный КЭШ донорских стрелок
    !global $cash = ""

    '/Буферная переменная для построения карты процесса в табличном виде и в виде текста с разделителем.
    '/См. процедуры LEGEND, NOTE
    !global $tableProcessDescription="| №\n | id | Инициатор\n | Исполнитель\n | Вызов/Метод\n | Комментарий\n |"
    !global $csvProcessDescription="№;id;Инициатор;Исполнитель;Вызов/метод;Комментарий"


'/5. ПРОЦЕДУРЫ ВЗАИМОДЕЙСТИЯ
'/Процедура для создания карты процессов в табличном виде и в виде текста с разделителями
!unquoted procedure $processDescriptionBuilder($techCounter, $counter, $initiator, $executor, $action, $comment="")
    !$csvProcessDescription = $csvProcessDescription + %newline() + $techCounter + ";" + $counter + ";" + $initiator + ";"+ $executor + ";" + $action + ";" + $comment
    !$tableProcessDescription = $tableProcessDescription + %newline() + "| " +  $techCounter + " | "+  $counter + " | " + $initiator + " | "+ $executor + " | " + $action + " | " + $comment + " |"
!endprocedure

'/Процедура для отрисовки взаимодействия между участниками

!unquoted procedure $counterCalculator($altLevel,$donor="")
    !if $altLevel == 0
        !$counter = $counter + 1
    !endif
!endprocedure

!unquoted procedure ACTION($initiator, $executor, $liveLine="",$action, $comment="")
    !$counter = $counter + 1
    !$techCounter = $techCounter + 1
    $initiator -> $executor $liveLine: <size:12>**$counter**</size> $action
    %invoke_procedure("$processDescriptionBuilder", $techCounter, $counter, $initiator, $executor, $action, $comment)
!endprocedure

'/Процедура для отрисовки альтернативного взаимодействия между участниками
!unquoted procedure ALT($condition, $donor="", $color="")
    !$altLevel = $altLevel + 1
    %invoke_procedure("$cashApi", post, $altLevel, $donor)
    !if $donor != ""
        !$counter = %intval($donor) - 1
    !endif

    !if $color == ""
        !if $altLevel == 1
            alt $altColor $condition
        !elseif $altLevel > 1
            alt %lighten($altColor, %intval($altLevel*$altColorStep)) $condition
        !endif
    !elseif $color != ""
        alt $color $condition
    !endif
!endprocedure

'/Процедура для отрисовки еще одного альтернативного взаимодействия между участниками
!unquoted procedure ELSE_ALT($condition, $color="")
    %invoke_procedure("$cashApi", get, $altLevel)
    !$donor = $donorCounter
    !if %intval($donor) > 0
        !$counter = %intval($donor) - 1
    !elseif %intval($donor) == 0
        !$counter = %intval($donor)
    !endif

    !if $color == ""
        !if $altLevel == 1
            else %reverse_color($altColor) $condition
        !elseif $altLevel > 1
            else %reverse_color(%lighten($altColor, %intval($altLevel*$altColorStep))) $condition
        !endif
    !elseif $color != ""
        else $color $condition
    !endif
!endprocedure

'/Процедура для завершения отрисовки альтернативного взаимодействия между участниками
!unquoted procedure END_ALT()
    %invoke_procedure("$cashApi",delete, $altLevel)
    !$altLevel = $altLevel - 1
    end alt
!endprocedure

'/Процедура, инициирующая КЭШ и методы работы с ним
!unquoted procedure $cashApi($method, $level="", $donor="")
    '/Определение длинн $counter и $donor
    !$donorLength = %strlen(%intval($donor))
    !$counterLength = %strlen(%intval($counter))

    '/1. Создание объекта в КЭШе
    !if $method == "post"
        !$unicodeLevel = %chr($level + 64)
        !if $altLevel == 1
            !$cash = $cash + "{id:" + $unicodeLevel + ", " + "donor_length:"+ $donorLength + ", "+ "donor:" + $donor + ", " + "counter_length:" + $counterLength + ", " + "counter:" + $counter + ", " + "tech_counter:" + $techCounter + "}"
        !elseif $altLevel > 1
            !$cash = $cash + %newline() + "{id:" + $unicodeLevel + ", " + "donor_length:"+ $donorLength + ", "+ "donor:" + $donor + ", " + "counter_length:" + $counterLength + ", " + "counter:" + $counter + ", " + "tech_counter:" + $techCounter + "}"
        !endif

    '/2. Присвоение буферной переменной $donorCounter соответствующего запрашиваемому уровню альта значения из КЭШа
    !elseif ($method == "get" && $level != "")
        !$levelIndex = %strpos($cash, %chr(%intval($level) + 64))
        !$donorLengthIndex = %intval($levelIndex+16)
        !$donorLength = %intval(%substr($cash, %intval($donorLengthIndex), 1))
        !$donorIndex = %intval($levelIndex+25)
        !$donorCounter = %intval(%substr($cash, $donorIndex, $donorLength))

    '/3. Получить все объекты из КЭШа
    !elseif ($method == "get")

note across
$cash
end note

    '/4. Удаление объекта КЭШа
    !elseif $method == "delete"
        !$levelIndex = %strpos($cash, %chr(%intval($level) + 64))
        !$counterLengthIndex = %intval($levelIndex+43)
        !$counterLength = %intval(%substr($cash, %intval($counterLengthIndex), 1))
        !$counterIndex = %intval($levelIndex+54)
        !$counter = %intval(%substr($cash, $counterIndex, $counterLength))  
        !if $counter == 0
            !$counter = $counter + 1
        !endif

        !if $altLevel == 1
            !$cash = ""
        !elseif $altLevel > 1
            !$levelIndex = %strpos($cash, %chr(%intval($level) + 64))
            !$cash = %substr($cash, 0, (%intval($levelIndex)-5))
        !endif
    !endif
!endprocedure


'/ПАРАМЕТРЫ СТИЛЯ
hide unlinked
skinparam maxMessageSize 150
skinparam backgroundColor LightGray
skinparam sequence {
ArrowColor blue
LifeLineBorderColor blue
LifeLineBackgroundColor White
ParticipantBorderColor blue
ParticipantBackgroundColor lightBlue-DodgerBlue
ParticipantFontName Impact
ParticipantFontSize 17
ParticipantFontColor darkblue
ActorBorderColor darkblue
ActorBackgroundColor DodgerBlue
ActorFontName Impact
ActorFontColor DarkBlue
ActorFontSize 17
}

<style>
legend {
FontSize 16
FontColor white
BackGroundColor black
}
</style>
@enduml